version: "2.1"

services:
  adguard:
    image: adguard/adguardhome:latest
    network_mode: host
    privileged: true
    volumes:
      - "adguardhome_work:/opt/adguardhome/work:rw"
      - "adguardhome_conf:/opt/adguardhome/conf:rw"
    command:
      - "--no-check-update"
      - "--web-addr"
      - "0.0.0.0:80"
      - "--config"
      - "/opt/adguardhome/conf/AdGuardHome.yaml"

  # https://hub.docker.com/r/homeassistant/home-assistant
  homeassistant:
    image: homeassistant/home-assistant:latest
    network_mode: host
    volumes:
      - config:/config
    labels:
      io.balena.features.dbus: "1"
    environment:
      DBUS_SYSTEM_BUS_ADDRESS: unix:path=/host/run/dbus/system_bus_socket
    privileged: true

  # https://github.com/balenablocks/hostname
  hostname:
    build: hostname
    restart: no
    labels:
      io.balena.features.supervisor-api: 1
    environment:
      SET_HOSTNAME: homeassistant

  # https://github.com/home-assistant-libs/python-matter-server/blob/main/docs/docker.md
  matter-server:
    image: ghcr.io/home-assistant-libs/python-matter-server:stable
    # Required for mDNS to work correctly
    network_mode: host
    security_opt:
      # Required for Bluetooth via D-Bus
      - apparmor:unconfined
    volumes:
      - config:/volumes/config
      - tailscale:/volumes/tailscale
      - netdatalib:/volumes/netdatalib

  # https://github.com/klutchell/balena-tailscale
  tailscale:
    build: tailscale
    image: bh.cr/klutchell_blocks/tailscale-aarch64
    network_mode: host
    restart: on-failure
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    labels:
      io.balena.features.kernel-modules: 1
    tmpfs:
      - /tmp
      - /var/run/
    environment:
      TS_EXTRA_ARGS: --reset
      REQUIRE_AUTH_KEY: true

  netdata:
    image: netdata/netdata:latest
    privileged: true
    network_mode: host
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    labels:
      io.balena.features.balena-socket: 1
      io.balena.features.procfs: 1
      io.balena.features.supervisor-api: 1
      io.balena.features.sysfs: 1
    volumes:
      - tailscale:/var/lib/tailscale

  zwave-js-ui:
    container_name: zwave-js-ui
    image: zwavejs/zwave-js-ui:latest
    network_mode: host
    restart: always
    tty: true
    stop_signal: SIGINT
    environment:
      - SESSION_SECRET=mysupersecretkey
      - ZWAVEJS_EXTERNAL_CONFIG=/usr/src/app/store/.config-db
      # Uncomment if you want logs time and dates to match your timezone instead of UTC
      # Available at https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
      #- TZ=America/New_York
    devices:
      # Do not use /dev/ttyUSBX serial devices, as those mappings can change over time.
      # Instead, use the /dev/serial/by-id/X serial device for your Z-Wave stick.
      - "/dev/serial/by-id/usb-Zooz_800_Z-Wave_Stick_533D004242-if00:/dev/zwave"
    volumes:
      - zwave-config:/usr/src/app/store
    ports:
      - "8091:8091" # port for web interface
      - "3000:3000" # port for Z-Wave JS websocket server

volumes:
  adguardhome_work: {}
  adguardhome_conf: {}
  config: {}
  netdatalib: {}
  tailscale: {}
  zwave-config: {}
